#!/bin/bash
#$1 project name, $2 package, $3 class name, $4 tested method, $5 testing tool used

#generate specifications with daikon for a given subject using tests generated by 
#the given tool

cd subjects/$1/
./gradlew jar          #rebuild subject so tests are present in the .jar file
cd ../../

subject_jar=subjects/$1/build/libs/simple-examples-1.0-SNAPSHOT.jar

output_dir=generated_specs/$1

if [ $5 == "randoop" ]; then
    output_dir=$output_dir/randoop
    mkdir -p $output_dir        #create directory to save generated specs
    rm -f $output_dir/*         #delete old specs if any
    log=$output_dir/log.txt
    touch $log

    ./scripts/utils/print_sign.sh "first daikon command" > $log
    java -cp $subject_jar:$DAIKONDIR/daikon.jar daikon.DynComp $2.RegressionTestDriver >> $log 2>&1
    ./scripts/utils/print_sign.sh "second daikon command" >> $log
    java -cp $subject_jar:$DAIKONDIR/daikon.jar daikon.Chicory --daikon --ppt-omit-pattern="$2\.RegressionTest|org.junit.Assert" --output-dir=$output_dir --comparability-file=RegressionTestDriver.decls-DynComp $2.RegressionTestDriver >> $log 2>&1

    rm -f RegressionTestDriver.decls-DynComp
    mv RegressionTestDriver.inv.gz $output_dir/RegressionTestDriver.inv.gz
    rm -f $output_dir/RegressionTestDriver.dtrace.gz

    ./scripts/utils/print_sign.sh "printing invariants" >> $log
    ./scripts/utils/print_invariants.sh $output_dir/RegressionTestDriver.inv.gz $2.$3 $4 $output_dir/randoop_inv.txt  >> $log 2>&1

elif [ $5 == "evosuite" ]; then
    output_dir=$output_dir/evosuite
    mkdir -p $output_dir             #create directory to save generated specs
    rm -f $output_dir/*              #delete old specs if any
    log=$output_dir/log.txt
    touch $log

    ./scripts/utils/print_sign.sh "first daikon command" > $log
    java -cp $subject_jar:$DAIKONDIR/daikon.jar:libs/evosuite-standalone-runtime-1.0.6.jar daikon.DynComp $2.TestDriverEvosuite >> $log 2>&1
    ./scripts/utils/print_sign.sh "second daikon command" >> $log
    java -cp $subject_jar:$DAIKONDIR/daikon.jar daikon.Chicory --daikon --ppt-omit-pattern="$2\.$3_ESTest|org.slf4j|org.evosuite|org.junit.Assert" --output-dir=$output_dir --comparability-file=TestDriverEvosuite.decls-DynComp $2.TestDriverEvosuite >> $log 2>&1
    
    rm -f TestDriverEvosuite.decls-DynComp
    mv TestDriverEvosuite.inv.gz $output_dir/TestDriverEvosuite.inv.gz
    rm -f $output_dir/TestDriverEvosuite.dtrace.gz

    ./scripts/utils/print_sign.sh "printing invariants" >> $log
    ./scripts/utils/print_invariants.sh $output_dir/TestDriverEvosuite.inv.gz $2.$3 $4 $output_dir/evosuite_inv.txt >> $log 2>&1
    
else
    echo -e "\n\n\n${RED}invalid testing tool provided, expected randoop or evosuite, but received $5 ${NORMAL}\n"
fi
